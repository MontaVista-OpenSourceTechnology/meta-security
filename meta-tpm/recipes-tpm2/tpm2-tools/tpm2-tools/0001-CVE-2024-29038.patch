From 66d922d6547b7b4fe4f274fb2ec10b376e0e259c Mon Sep 17 00:00:00 2001
From: Juergen Repp <juergen_repp@web.de>
Date: Tue, 31 Oct 2023 11:29:50 +0100
Subject: [PATCH] CVE-2024-29038: tpm2_checkquote: Fix check of magic number.

Upstream-Status: Backport from https://github.com/tpm2-software/tpm2-tools/commit/66d922d6547b7b4fe4f274fb2ec10b376e0e259c
CVE: CVE-2024-29038

Signed-off-by: Rohini Sangam <rsangam@mvista.com>
---
 .../4.1.3-r0/tpm2-tools-4.1.3/tools/misc/tpm2_checkquote.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/tools/misc/tpm2_checkquote.c b/tools/misc/tpm2_checkquote.c
index 8beeaeb..3d09b47 100644
--- a/tools/misc/tpm2_checkquote.c
+++ b/tools/misc/tpm2_checkquote.c
@@ -93,6 +93,13 @@ static bool verify_signature() {
         goto err;
     }
 
+    // check magic
+    if (ctx.attest.magic != TPM2_GENERATED_VALUE) {
+        LOG_ERR("Bad magic, got: 0x%x, expected: 0x%x",
+                ctx.attest.magic, TPM2_GENERATED_VALUE);
+        return false;
+    }
+
     // Also ensure digest from quote matches PCR digest
     if (ctx.flags.pcr) {
         if (!tpm2_util_verify_digests(&ctx.attest.attested.quote.pcrDigest,
-- 
2.24.4

