From d86c5f9f0c75736d4fce93e27c0773fcb27e1047 Mon Sep 17 00:00:00 2001
From: Victor Julien <vjulien@oisf.net>
Date: Mon, 17 Mar 2025 21:19:13 +0100
Subject: [PATCH] datasets: set higher hashsize limits

To avoid possible upgrade issues, allow higher defaults than in the
master branch. Add some upgrade guidance and a note that defaults will
probably be further reduced.

Upstream-Status: Backport [https://github.com/OISF/suricata/commit/d86c5f9f0c75736d4fce93e27c0773fcb27e1047]
CVE: CVE-2025-29916
Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/datasets.c   | 5 +++--
 suricata.yaml.in | 5 +++--
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/src/datasets.c b/src/datasets.c
index 0729894..f99f63c 100644
--- a/src/datasets.c
+++ b/src/datasets.c
@@ -45,8 +45,9 @@ SCMutex sets_lock = SCMUTEX_INITIALIZER;
 static Dataset *sets = NULL;
 static uint32_t set_ids = 0;
 
-uint32_t dataset_max_one_hashsize = 65536;
-uint32_t dataset_max_total_hashsize = 16777216;
+/* 4x what we set in master to allow a smoother upgrade path */
+uint32_t dataset_max_one_hashsize = 262144;
+uint32_t dataset_max_total_hashsize = 67108864;
 uint32_t dataset_used_hashsize = 0;
 
 static int DatasetAddwRep(Dataset *set, const uint8_t *data, const uint32_t data_len,
diff --git a/suricata.yaml.in b/suricata.yaml.in
index b218515..59db9ef 100644
--- a/suricata.yaml.in
+++ b/suricata.yaml.in
@@ -1169,11 +1169,12 @@ datasets:
 
   # Limits for per rule dataset instances to avoid rules using too many
   # resources.
+  # Note: in Suricata 8 the built-in default will be set to lower values.
   limits:
     # Max value for per dataset `hashsize` setting
-    #single-hashsize: 65536
+    #single-hashsize: 262144
     # Max combined hashsize values for all datasets.
-    #total-hashsizes: 16777216
+    #total-hashsizes: 67108864
 
   rules:
     # Set to true to allow absolute filenames and filenames that use
-- 
2.49.0

