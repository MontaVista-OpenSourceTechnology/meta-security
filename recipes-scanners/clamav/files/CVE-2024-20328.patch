From c9a341177fe9790ac433222c64e50473060d9955 Mon Sep 17 00:00:00 2001
From: Vivek Kumbhar <vkumbhar@mvista.com>
Date: Mon, 12 Aug 2024 12:45:02 +0000
Subject: [PATCH] CVE-2024-20328

---
 docs/man/clamd.conf.5.in              | 13 ++++++++++---
 etc/clamd.conf.sample                 | 16 ++++++++++++----
 shared/optparser.c                    |  2 +-
 win32/conf_examples/clamd.conf.sample | 16 ++++++++++++----
 4 files changed, 35 insertions(+), 12 deletions(-)

diff --git a/docs/man/clamd.conf.5.in b/docs/man/clamd.conf.5.in
index 5ef2ca20a..beca00205 100644
--- a/docs/man/clamd.conf.5.in
+++ b/docs/man/clamd.conf.5.in
@@ -235,9 +235,16 @@ should perform a database check.
 Default: 600
 .TP 
 \fBVirusEvent COMMAND\fR
-Execute a command when a virus is found. In the command string %v will be
-replaced with the virus name. Additionally, two environment variables will
-be defined: $CLAM_VIRUSEVENT_FILENAME and $CLAM_VIRUSEVENT_VIRUSNAME.
+Execute a command when virus is found.
+Use the following environment variables to identify the file and virus names:
+- $CLAM_VIRUSEVENT_FILENAME
+- $CLAM_VIRUSEVENT_VIRUSNAME
+In the command string, '%v' will also be replaced with the virus name.
+Note: The '%f' filename format character has been disabled and will no longer
+be replaced with the file name, due to command injection security concerns.
+Use the 'CLAM_VIRUSEVENT_FILENAME' environment variable instead.
+For the same reason, you should NOT use the environment variables in the
+command directly, but should use it carefully from your executed script.
 \fR
 .br 
 Default: disabled
diff --git a/etc/clamd.conf.sample b/etc/clamd.conf.sample
index efeec6a0e..54bf84a9c 100644
--- a/etc/clamd.conf.sample
+++ b/etc/clamd.conf.sample
@@ -197,10 +197,18 @@ Example
 # Default: 600 (10 min)
 #SelfCheck 600

-# Execute a command when virus is found. In the command string %v will
-# be replaced with the virus name.
-# Default: no
-#VirusEvent /usr/local/bin/send_sms 123456789 "VIRUS ALERT: %v"
+# Execute a command when virus is found.
+# # Use the following environment variables to identify the file and virus names:
+# # - $CLAM_VIRUSEVENT_FILENAME
+# # - $CLAM_VIRUSEVENT_VIRUSNAME
+# # In the command string, '%v' will also be replaced with the virus name.
+# # Note: The '%f' filename format character has been disabled and will no longer
+# # be replaced with the file name, due to command injection security concerns.
+# # Use the 'CLAM_VIRUSEVENT_FILENAME' environment variable instead.
+# # For the same reason, you should NOT use the environment variables in the
+# # command directly, but should use it carefully from your executed script.
+# # Default: no
+# #VirusEvent /opt/send_virus_alert_sms.sh

 # Run as another user (clamd must be started by root for this option to work)
 # Default: don't drop privileges
diff --git a/shared/optparser.c b/shared/optparser.c
index ffc706a0e..fa21f3b01 100644
--- a/shared/optparser.c
+++ b/shared/optparser.c
@@ -271,7 +271,7 @@ const struct clam_option __clam_options[] = {

     { "DisableCache", "disable-cache", 0, CLOPT_TYPE_BOOL, MATCH_BOOL, 0, NULL, 0, OPT_CLAMD | OPT_CLAMSCAN, "This option allows you to disable clamd's caching feature.", "no" },

-    { "VirusEvent", NULL, 0, CLOPT_TYPE_STRING, NULL, -1, NULL, 0, OPT_CLAMD, "Execute a command when a virus is found. In the command string %v will be\nreplaced with the virus name. Additionally, two environment variables will\nbe defined: $CLAM_VIRUSEVENT_FILENAME and $CLAM_VIRUSEVENT_VIRUSNAME.", "/usr/bin/mailx -s \"ClamAV VIRUS ALERT: %v\" alert < /dev/null" },
+    {"VirusEvent", NULL, 0, CLOPT_TYPE_STRING, NULL, -1, NULL, 0, OPT_CLAMD, "Execute a command when virus is found.\nUse the following environment variables to identify the file and virus names:\n- $CLAM_VIRUSEVENT_FILENAME\n- $CLAM_VIRUSEVENT_VIRUSNAME\nIn the command string, '%v' will also be replaced with the virus name.\nNote: The '%f' filename format character has been disabled and will no longer\nbe replaced with the file name, due to command injection security concerns.\nUse the 'CLAM_VIRUSEVENT_FILENAME' environment variable instead.\nFor the same reason, you should NOT use the environment variables in the\ncommand directly, but should use it carefully from your executed script.", "/opt/send_virus_alert_sms.sh"},

     { "ExitOnOOM", NULL, 0, CLOPT_TYPE_BOOL, MATCH_BOOL, 0, NULL, 0, OPT_CLAMD, "Stop the daemon when libclamav reports an out of memory condition.", "yes" },

diff --git a/win32/conf_examples/clamd.conf.sample b/win32/conf_examples/clamd.conf.sample
index 1539c06c4..44438b808 100644
--- a/win32/conf_examples/clamd.conf.sample
+++ b/win32/conf_examples/clamd.conf.sample
@@ -169,10 +169,18 @@ TCPAddr 127.0.0.1
 # Default: 600 (10 min)
 #SelfCheck 600

-# Execute a command when virus is found. In the command string %v will
-# be replaced with the virus name.
-# Default: no
-#VirusEvent "C:\example\SendEmail.ps1" email@addresscom "VIRUS ALERT: %v"
+# Execute a command when virus is found.
+# # Use the following environment variables to identify the file and virus names:
+# # - $CLAM_VIRUSEVENT_FILENAME
+# # - $CLAM_VIRUSEVENT_VIRUSNAME
+# # In the command string, '%v' will also be replaced with the virus name.
+# # Note: The '%f' filename format character has been disabled and will no longer
+# # be replaced with the file name, due to command injection security concerns.
+# # Use the 'CLAM_VIRUSEVENT_FILENAME' environment variable instead.
+# # For the same reason, you should NOT use the environment variables in the
+# # command directly, but should use it carefully from your executed script.
+# # Default: no
+# #VirusEvent "C:\example\SendVirusAlertEmail.ps1"

 # Run as another user (clamd must be started by root for this option to work)
 # Default: don't drop privileges
--
2.24.4
